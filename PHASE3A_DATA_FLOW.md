# Phase 3A: Data Flow Analysis

## ğŸ“– ä»æ•°æ®åº“è¯»å–çš„æ•°æ®

### 1. é¡µé¢åŠ è½½æ—¶ (`GET /api/progress/resume`)

**åç«¯è¯»å–**:
- `User` è¡¨: `last_question_id`, `id`
- `Question` è¡¨: å®Œæ•´é—®é¢˜æ•°æ®ï¼ˆid, domain, question_text, options, correct_answers, explanation, etc.ï¼‰
- `UserProgress` è¡¨: å½“å‰é—®é¢˜çš„è¿›åº¦ï¼ˆstatus, selected_answerï¼‰

**è¿”å›ç»™å‰ç«¯**:
```typescript
{
  success: true,
  question_id: number,
  question: {
    id, domain, question_text, options, correct_answers, explanation, ...
  },
  progress: {
    status: 'not_started' | 'correct' | 'wrong',
    selected_answer?: string[]
  }
}
```

### 2. æäº¤ç­”æ¡ˆå (`POST /api/progress`)

**åç«¯è¯»å–**:
- `User` è¡¨: `id` (ä» session)
- `Question` è¡¨: `correct_answers` (ç”¨äºéªŒè¯ç­”æ¡ˆ)

**åç«¯å†™å…¥**:
- `UserProgress` è¡¨: 
  - `status`: 'correct' æˆ– 'wrong'
  - `selected_answer`: ç”¨æˆ·é€‰æ‹©çš„ç­”æ¡ˆ
  - `updated_at`: å½“å‰æ—¶é—´
- `WrongBook` è¡¨ (å¦‚æœç­”æ¡ˆé”™è¯¯):
  - `wrong_count`: é€’å¢ 1
  - `last_wrong_at`: å½“å‰æ—¶é—´
- `User` è¡¨:
  - `last_question_id`: æ›´æ–°ä¸ºå½“å‰é—®é¢˜ ID
  - `last_active_at`: å½“å‰æ—¶é—´

**è¿”å›ç»™å‰ç«¯**:
```typescript
{
  success: true,
  progress: {
    status: 'correct' | 'wrong',
    selected_answer: string[],
    wrong_count?: number  // å¦‚æœé”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯æ¬¡æ•°
  }
}
```

---

## ğŸ’¾ å†™å…¥æ•°æ®åº“çš„æ•°æ®

### ç”¨æˆ·æäº¤ç­”æ¡ˆæ—¶ (`POST /api/progress`)

**äº‹åŠ¡æ“ä½œ**:

1. **UserProgress** (Upsert):
   - `user_id`: ä» session è·å–
   - `question_id`: ä»è¯·æ±‚è·å–
   - `status`: 'correct' æˆ– 'wrong' (ç”±åç«¯è®¡ç®—)
   - `selected_answer`: ç”¨æˆ·é€‰æ‹©çš„ç­”æ¡ˆæ•°ç»„
   - `updated_at`: è‡ªåŠ¨æ›´æ–°

2. **WrongBook** (å¦‚æœç­”æ¡ˆé”™è¯¯):
   - `user_id`: ä» session è·å–
   - `question_id`: ä»è¯·æ±‚è·å–
   - `wrong_count`: å¦‚æœå­˜åœ¨åˆ™ +1ï¼Œå¦åˆ™åˆ›å»ºä¸º 1
   - `last_wrong_at`: å½“å‰æ—¶é—´

3. **User** (Update):
   - `last_question_id`: æ›´æ–°ä¸ºå½“å‰é—®é¢˜ ID
   - `last_active_at`: å½“å‰æ—¶é—´

**å…³é”®ç‚¹**:
- æ‰€æœ‰æ“ä½œåœ¨æ•°æ®åº“äº‹åŠ¡ä¸­æ‰§è¡Œ
- æ­£ç¡®æ€§ç”±åç«¯éªŒè¯ï¼ˆæ¯”è¾ƒ `selected_answer` å’Œ `correct_answers`ï¼‰
- å‰ç«¯ä¸å‚ä¸æ­£ç¡®æ€§åˆ¤æ–­

---

## âŒ Phase 3A ä¸å®ç°çš„åŠŸèƒ½

### æ˜ç¡®ä¸å®ç°ï¼š

1. **è§£é‡Šæ˜¾ç¤º**
   - âŒ ä¸æ˜¾ç¤º `explanation` (å®˜æ–¹è§£é‡Š)
   - âŒ ä¸æ˜¾ç¤º `explanation_ai_en` (AI è‹±æ–‡è§£é‡Š)
   - âŒ ä¸æ˜¾ç¤º `explanation_ai_ch` (AI ä¸­æ–‡è§£é‡Š)
   - âŒ ä¸å®ç°è§£é‡Šé¢æ¿æˆ–æ ‡ç­¾é¡µ

2. **èŠå¤©åŠŸèƒ½**
   - âŒ ä¸å®ç°é—®é¢˜èŠå¤©ç•Œé¢
   - âŒ ä¸è°ƒç”¨ `/api/chat/:questionId`
   - âŒ ä¸æ˜¾ç¤ºèŠå¤©å†å²

3. **å¯¼èˆªåŠŸèƒ½**
   - âŒ ä¸å®ç°ä¸Šä¸€é¢˜/ä¸‹ä¸€é¢˜æŒ‰é’®
   - âŒ ä¸å®ç°é—®é¢˜åˆ—è¡¨
   - âŒ ä¸å®ç°è·³è½¬åˆ°ç‰¹å®šé—®é¢˜

4. **ä»ªè¡¨æ¿**
   - âŒ ä¸å®ç°è¿›åº¦ç»Ÿè®¡é¡µé¢
   - âŒ ä¸å®ç°å®Œæˆç‡æ˜¾ç¤º
   - âŒ ä¸å®ç°é”™é¢˜æœ¬é¡µé¢

5. **å…¶ä»–åŠŸèƒ½**
   - âŒ ä¸ä¿®æ”¹ Prisma schema
   - âŒ ä¸ä¿®æ”¹è®¤è¯é€»è¾‘
   - âŒ ä¸å®ç°ç”¨æˆ·è®¾ç½®
   - âŒ ä¸å®ç°é¢˜ç›®ç­›é€‰

---

## âœ… Phase 3A å®ç°çš„åŠŸèƒ½

### ä»…å®ç°ï¼š

1. **é—®é¢˜é¡µé¢**
   - âœ… æ˜¾ç¤ºé—®é¢˜æ–‡æœ¬
   - âœ… æ˜¾ç¤ºé€‰é¡¹ (A, B, C, D, ...)
   - âœ… å…è®¸é€‰æ‹©ç­”æ¡ˆï¼ˆå•é€‰æˆ–å¤šé€‰ï¼Œæ ¹æ® correct_answers é•¿åº¦åˆ¤æ–­ï¼‰

2. **ç­”æ¡ˆæäº¤**
   - âœ… æäº¤æŒ‰é’®
   - âœ… è°ƒç”¨ `POST /api/progress`
   - âœ… æ˜¾ç¤ºåç«¯è¿”å›çš„æ­£ç¡®/é”™è¯¯çŠ¶æ€

3. **çŠ¶æ€æ˜¾ç¤º**
   - âœ… æ˜¾ç¤ºå½“å‰é—®é¢˜çš„è¿›åº¦çŠ¶æ€ï¼ˆå¦‚æœå·²æäº¤ï¼‰
   - âœ… æ˜¾ç¤ºç”¨æˆ·ä¹‹å‰é€‰æ‹©çš„ç­”æ¡ˆï¼ˆå¦‚æœæœ‰ï¼‰
   - âœ… æäº¤åç¦ç”¨è¾“å…¥æˆ–æ˜¾ç¤ºåªè¯»çŠ¶æ€

4. **çŠ¶æ€æŒä¹…åŒ–**
   - âœ… é¡µé¢åˆ·æ–°åçŠ¶æ€æ¢å¤ï¼ˆä»åç«¯è·å–ï¼‰
   - âœ… ä¸åŒè®¾å¤‡æ˜¾ç¤ºç›¸åŒçŠ¶æ€ï¼ˆä»åç«¯è·å–ï¼‰

---

## ğŸ”„ æ•°æ®æµå›¾

```
é¡µé¢åŠ è½½:
  å‰ç«¯ â†’ GET /api/progress/resume
  åç«¯ â†’ è¯»å– User, Question, UserProgress
  åç«¯ â†’ è¿”å› question + progress
  å‰ç«¯ â†’ æ¸²æŸ“é—®é¢˜å’ŒçŠ¶æ€

ç”¨æˆ·é€‰æ‹©ç­”æ¡ˆ:
  å‰ç«¯ â†’ ç”¨æˆ·ç‚¹å‡»é€‰é¡¹
  å‰ç«¯ â†’ æ›´æ–°æœ¬åœ°é€‰æ‹©çŠ¶æ€ï¼ˆæœªæäº¤ï¼‰

ç”¨æˆ·æäº¤ç­”æ¡ˆ:
  å‰ç«¯ â†’ POST /api/progress { question_id, selected_answer, is_correct }
  åç«¯ â†’ éªŒè¯ç­”æ¡ˆï¼ˆæ¯”è¾ƒ selected_answer å’Œ correct_answersï¼‰
  åç«¯ â†’ å†™å…¥ UserProgress, WrongBook (å¦‚æœé”™è¯¯), User
  åç«¯ â†’ è¿”å› { status, wrong_count }
  å‰ç«¯ â†’ æ˜¾ç¤ºæ­£ç¡®/é”™è¯¯çŠ¶æ€
  å‰ç«¯ â†’ ç¦ç”¨è¾“å…¥æˆ–æ˜¾ç¤ºåªè¯»çŠ¶æ€

é¡µé¢åˆ·æ–°:
  å‰ç«¯ â†’ GET /api/progress/resume
  åç«¯ â†’ è¯»å–æœ€æ–°çŠ¶æ€
  åç«¯ â†’ è¿”å› question + progress (åŒ…å«å·²æäº¤çš„çŠ¶æ€)
  å‰ç«¯ â†’ æ¸²æŸ“é—®é¢˜å’ŒçŠ¶æ€ï¼ˆåŒ…æ‹¬å·²æäº¤çš„ç­”æ¡ˆï¼‰
```

---

## ğŸ¯ å…³é”®è®¾è®¡åŸåˆ™

1. **åç«¯é©±åŠ¨**: æ‰€æœ‰çŠ¶æ€æ¥è‡ªåç«¯ï¼Œå‰ç«¯ä¸çŒœæµ‹
2. **çŠ¶æ€åŒæ­¥**: æ¯æ¬¡é¡µé¢åŠ è½½éƒ½ä»åç«¯è·å–æœ€æ–°çŠ¶æ€
3. **æ­£ç¡®æ€§éªŒè¯**: åç«¯æ¯”è¾ƒç­”æ¡ˆï¼Œå‰ç«¯åªæ˜¾ç¤ºç»“æœ
4. **æŒä¹…åŒ–**: æ‰€æœ‰æ“ä½œç«‹å³å†™å…¥æ•°æ®åº“
5. **ä¸€è‡´æ€§**: ä¸åŒè®¾å¤‡çœ‹åˆ°ç›¸åŒçŠ¶æ€ï¼ˆéƒ½ä»æ•°æ®åº“è¯»å–ï¼‰

---

**End of Data Flow Analysis**

